<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dinamik Kripto Analiz Paneli</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            background-color: #f4f7f9; 
            font-family: 'Inter', sans-serif;
        }
        .card {
            border: none;
            border-radius: 0.75rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            height: 100%; 
        }
        .card-header {
            background-color: transparent;
            border-bottom: 1px solid #e9ecef;
            padding: 1rem 1.25rem;
            font-weight: 600;
            font-size: 1.0rem;
            color: #212529;
        }
        .table-hover tbody tr:hover {
            background-color: #eef2f5;
        }
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 0;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #dee2e6;
        }
        .main-header h1 {
            font-weight: 700;
            font-size: 2rem;
        }
        .table thead th {
            text-align: left; 
            font-size: 0.75rem; 
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #495057;
            vertical-align: middle;
        }
        .table td {
             font-size: 0.85rem;
             vertical-align: middle;
        }
        .settings-card .card-body {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
    </style>
</head>
<body>

<div class="container-fluid px-4 py-4">

    <!-- ANA BAŞLIK VE KILAVUZ LİNKİ -->
    <div class="main-header">
        <h1>Analiz Paneli</h1>
        <a href="/guide" class="btn btn-outline-primary">Kullanım Kılavuzu</a>
    </div>

    <!-- KONTROL PANELLERİ (ÜSTTE VE SİMETRİK) -->
    <div class="row g-4 mb-4">
        <!-- SOL SÜTUN: Piyasa Durumu ve Risk Yönetimi -->
        <div class="col-lg-6">
            <div class="card settings-card">
                <div class="card-header">Genel Durum ve Risk Ayarları</div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <h6 class="text-muted">Piyasa Yönü (BTC'ye Göre)</h6>
                        <div id="market-status-text" class="h5 mt-2 text-secondary">Yükleniyor...</div>
                    </div>
                    <hr>
                    <h6 class="text-muted text-center mt-3">Strateji Ayarları</h6>
                    <p class="small text-muted text-center">Bu ayarlar, projedeki <code>settings.json</code> dosyasından okunmaktadır. Değiştirmek için dosyayı güncelleyip GitHub'a göndermeniz yeterlidir.</p>
                </div>
            </div>
        </div>
        <!-- SAĞ SÜTUN: Puanlama Ağırlıkları (Sadece Gösterim) -->
        <div class="col-lg-6">
            <div class="card settings-card">
                <div class="card-header">Aktif Puanlama Ağırlıkları</div>
                <div class="card-body">
                    <ul id="weights-list" class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">Yükleniyor...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ANALİZ TABLOSU (TAM GENİŞLİKTE) -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    Analiz Sonuçları
                </div>
                <div class="card-body p-0">
                    <div id="loading-indicator" class="text-center p-5"><div class="spinner-border"></div><p class="mt-2">Sonuçlar yükleniyor...</p></div>
                    <div id="error-indicator" style="display: none;" class="text-center p-5"><p class="text-danger">Analiz verisi bulunamadı.</p></div>
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered table-sm m-0">
                            <thead class="text-start">
                                <tr>
                                    <th>Parite</th><th>Fiyat</th><th>MA(20)</th><th>MA(50)</th><th>RSI</th><th>MACD</th><th>Sinyal</th><th>BB Alt</th><th>BB Üst</th><th>ADX</th><th>Volatilite</th><th>Stop</th><th>Pozisyon (TL)</th><th class="text-primary">Skor</th>
                                </tr>
                            </thead>
                            <tbody id="analysis-table-body" class="text-center align-middle">
                                <!-- Veriler JavaScript ile eklenecek -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elementleri seçme
        const tbody = document.getElementById('analysis-table-body');
        const loading = document.getElementById('loading-indicator');
        const error = document.getElementById('error-indicator');
        const marketStatusEl = document.getElementById('market-status-text');
        const weightsListEl = document.getElementById('weights-list');

        // Analiz verilerini çekme
        // DÜZELTME: new URL() kaldırıldı ve göreli yol doğrudan kullanıldı.
        fetch('results.json?v=' + new Date().getTime())
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                if (data && data.length > 0) {
                    data.sort((a, b) => b.score - a.score);
                    populateTable(data);
                } else {
                    error.style.display = 'block';
                }
            })
            .catch(err => {
                loading.style.display = 'none';
                error.style.display = 'block';
                console.error("Analiz verisi çekme hatası:", err);
            });
        
        // Ayarları ve Piyasa Durumunu çekmek için app.py'ye yeni bir endpoint eklememiz gerekecek
        // Şimdilik sadece ayarları göstermek için bir yapı oluşturalım.
        // Bu, daha sonra geliştirilebilir.
        // settings.json dosyasını çekip gösterelim:
        // DÜZELTME: new URL() kaldırıldı ve göreli yol doğrudan kullanıldı.
        fetch('settings.json')
             .then(response => response.json())
             .then(settings => {
                weightsListEl.innerHTML = ''; // Temizle
                const weights = {
                    "MA Kesişimi": settings.weight_ma,
                    "RSI Seviyesi": settings.weight_rsi,
                    "Hacim Artışı": settings.weight_volume,
                    "MACD": settings.weight_macd,
                    "Bollinger Band": settings.weight_bb,
                    "ADX": settings.weight_adx,
                };
                for(const [key, value] of Object.entries(weights)) {
                    const li = `<li class="list-group-item d-flex justify-content-between align-items-center">
                                    ${key}
                                    <span class="badge bg-primary rounded-pill">${value}%</span>
                                </li>`;
                    weightsListEl.innerHTML += li;
                }
             })
             .catch(err => {
                weightsListEl.innerHTML = '<li class="list-group-item text-danger">Ayar dosyası okunamadı.</li>';
             });

        function populateTable(coins) {
            tbody.innerHTML = ''; // Tabloyu temizle
            coins.forEach(coin => {
                const score = coin.score || 0;
                const rowClass = score >= 70 ? 'table-success' : (score >= 40 ? 'table-warning' : '');
                const row = `
                    <tr class="${rowClass}">
                        <td class="text-start"><strong>${coin.symbol}</strong></td>
                        <td>${(coin.price || 0).toFixed(2)}</td>
                        <td>${(coin.ma20 || 0).toFixed(2)}</td>
                        <td>${(coin.ma50 || 0).toFixed(2)}</td>
                        <td>${(coin.rsi || 0).toFixed(2)}</td>
                        <td>${(coin.macd || 0).toFixed(2)}</td>
                        <td>${(coin.macd_signal || 0).toFixed(2)}</td>
                        <td>${(coin.bb_lower || 0).toFixed(2)}</td>
                        <td>${(coin.bb_upper || 0).toFixed(2)}</td>
                        <td>${(coin.adx || 0).toFixed(2)}</td>
                        <td>${(coin.volatility || 0).toFixed(4)}</td>
                        <td>${(coin.stop_loss || 0).toFixed(2)}</td>
                        <td>${Math.round(coin.position_tl || 0).toLocaleString('tr-TR')}</td>
                        <td class="fw-bold fs-6 text-primary">${score.toFixed(0)}</td>
                    </tr>`;
                tbody.innerHTML += row;
            });
        }
    });
</script>

</body>
</html>
